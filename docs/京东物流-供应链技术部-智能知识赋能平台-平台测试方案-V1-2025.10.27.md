# 平台测试方案说明书

## 项目名称：智能知识赋能平台

编制单位：物流供应链研发组  
编制人：齐海智  
版本号：v1.0  
日期：2025-10-27  
保密级别：内部机密

## 修订记录

| 版本号 | 日期       | 修订人 | 修订内容                         |
| ------ | ---------- | ------ | -------------------------------- |
| v1.0   | 2025-10-27 | 齐海智 | 初始版本，完成测试方案           |

## 1. 目标与范围

### 1.1 测试目标

本测试方案旨在验证基于 RAG 的"物流供应链-智能知识赋能系统"的功能完整性、系统稳定性及性能指标，确保系统满足需求规格说明书（SRS）和概要设计说明书（HLD）中的各项要求。

### 1.2 测试范围

本方案覆盖以下六大评测维度：
- 可运行性：系统在离线CPU环境下能否正常启动和运行
- 相关性：检索结果与查询的相关程度
- 完整性：输出内容是否完整、无缺失
- 引用准确性：引用来源是否可追溯、准确
- 指标校验：物流指标校验的准确性和容差处理
- 鲁棒性：系统对异常输入和场景的处理能力

### 1.3 测试约束

- 环境约束：仅CPU运行，禁用网络访问（证据：.env中USE_MOCK=true）
- 数据约束：使用物流供应链领域数据，不涉及财务/金融指标
- 工具约束：使用开源测试工具，无商业软件依赖

## 2. 环境与数据

### 2.1 测试环境

| 环境项     | 配置                            | 证据                   |
| ---------- | ------------------------------- | ---------------------- |
| 操作系统   | macOS 15.6.1                    | uname -a 输出          |
| CPU        | Intel Core i7                   | sysctl -n machdep.cpu  |
| 内存       | 16GB DDR4                       | system_profiler 输出   |
| 存储       | 512GB SSD                       | df -h 输出             |
| Python版本 | 3.10.12                         | python --version 输出  |
| 系统配置   | USE_GPU=false, USE_MOCK=true    | .env 文件              |

表2-1：测试环境配置

### 2.2 测试数据集

#### 2.2.1 原始数据

| 数据类型     | 文件数量 | 大小   | 说明                           | 证据路径              |
| ------------ | -------- | ------ | ------------------------------ | --------------------- |
| Java代码     | 2        | 13KB   | 仓储服务、订单管理等           | test_data/*.java      |
| Python代码   | 2        | 17KB   | 物流算法、分拣系统等           | test_data/*.py        |
| Markdown文档 | 1        | 3.6KB  | 系统API文档                    | test_data/*.md        |
| PDF文档      | 1        | 598KB  | 海智物流系统说明               | test_data/*.pdf       |
| 物流指标基准 | -        | -      | inventory_turnover等指标       | metric_validator.py   |

表2-2：原始测试数据集

#### 2.2.2 测试数据路径

- 首建库路径：test_data/
  - 包含从原始数据首次构建的索引
  - 用于验证索引构建功能
- 复用库路径：vectorstore/
  - 包含预构建的索引文件
  - 用于验证索引加载功能

#### 2.2.3 评测数据集

```json
{"question": "库存周转率的计算公式是什么？", "expected_answer": "库存周转率 = 销售成本 / 平均库存。平均库存 = (期初库存 + 期末库存) / 2。", "metrics": ["inventory_turnover"], "agent": "dev"}
{"question": "配送路线优化算法在哪？", "expected_answer": "配送路线优化算法位于test_data/TMSTransportationPlanner.py文件中的optimize_delivery_route函数", "metrics": [], "agent": "dev"}
{"question": "海智物流系统的分拣流程是怎样的？", "expected_answer": "海智物流系统的分拣流程包括接收包裹、分拣包裹、路由包裹和装车等步骤。", "metrics": [], "agent": "dev"}
{"question": "如何计算订单履约率？", "expected_answer": "订单履约率是衡量订单按时完成的比例，计算公式为：按时完成的订单数 / 总订单数。", "metrics": ["order_fulfillment_rate"], "agent": "product"}
```

## 3. 测试策略

### 3.1 测试层次

| 层次     | 测试内容       | 测试方法     | 用例数量 |
| -------- | -------------- | ------------ | -------- |
| 单元测试 | 单个模块功能   | 代码级测试   | 50+      |
| 组件测试 | 模块间接口     | 模拟依赖     | 20       |
| 集成测试 | 系统核心流程   | 端到端测试   | 15       |
| E2E测试  | 完整用户场景   | CLI模拟      | 10       |
| 性能测试 | 系统性能指标   | 负载测试     | 5        |

表3-1：测试层次规划

### 3.2 测试方法

#### 3.2.1 A/B测试（BM25开关）

- A组：USE_BM25=false（仅向量检索）
- B组：USE_BM25=true（混合检索）
- 对比指标：相关性、引用准确性、指标一致率
- 测试方法：使用相同查询集，比较两组结果

#### 3.2.2 Top-k敏感性测试

- 参数范围：k=3, 5, 10
- 测试内容：不同k值对检索结果质量的影响
- 评估指标：命中率、平均置信度、引用准确率

#### 3.2.3 指标校验验证

测试方法：
- 人工构造超差场景（6%）
- 验证系统是否正确标记notes并降低confidence
- 验证不同指标的容差是否正确应用

关键指标容差：
- inventory_turnover：5%容差
- order_fulfillment_rate：2%容差
- transit_time：10%容差

### 3.3 通过/退出准则

#### 3.3.1 通过准则

| 测试类型     | 通过阈值   | 验证方法         |
| ------------ | ---------- | ---------------- |
| 功能测试     | 100%用例通过 | 人工验证         |
| 引用准确性   | 90%        | 人工复核引用位置 |
| 指标一致率   | 95%        | 自动化验证       |
| 平均置信度   | 0.75       | 统计计算         |
| Top-k命中率  | 90%        | 人工评估         |
| 系统可用性   | <5%失败率  | 压力测试         |

表3-2：测试通过准则

#### 3.3.2 退出准则

必须退出：
- 关键功能（FR-01~FR-10）测试失败率 > 10%
- 指标校验（FR-08）功能完全失效
- 系统无法在离线CPU环境下运行

可继续但需记录：
- 非关键功能测试失败率 < 10%
- 性能指标略低于目标值（但可接受）

## 4. 测试用例设计

### 4.1 正向测试用例

| 用例ID | 测试点         | 步骤                                                                 | 期望结果                           | 量化阈值     |
| ------ | -------------- | -------------------------------------------------------------------- | ---------------------------------- | ------------ |
| TC-01  | 代码解析       | 1. 执行python main.py run --build-index<br>2. 检查日志               | 成功解析Java/Python代码            | 解析准确率95% |
| TC-02  | 文档解析       | 1. 导入Markdown/PDF文档<br>2. 验证文档结构                           | 保留标题层级与表格                 | 结构保留率90% |
| TC-03  | 代码切块       | 1. 分析WMSInventoryManagement.java<br>2. 检查切块结果                | 按函数边界切分                     | 语义断裂率5%  |
| TC-04  | 敏感数据脱敏   | 1. 导入含凭证的代码<br>2. 验证向量库                                 | 凭证被替换为[REDACTED]             | 脱敏率100%    |
| TC-05  | 索引构建       | 1. 执行python main.py run --build-index<br>2. 验证索引文件           | 成功创建FAISS索引                  | 构建时间10分钟 |
| TC-06  | 仅向量检索     | 1. 查询"库存周转率"<br>2. 检查结果                                   | 返回5条结果                        | 响应时间1s    |
| TC-07  | 混合检索       | 1. 设置USE_BM25=true<br>2. 查询"库存周转率"<br>3. 检查结果           | 返回5条去重结果                    | 响应时间1s    |
| TC-08  | 提示词裁剪     | 1. 提交长查询<br>2. 检查输入LLM的内容                                | 长度不超过MAX_CONTEXT_CHARS字符    | 截断准确率100% |
| TC-09  | MockLLM调用    | 1. 执行查询<br>2. 检查响应                                           | 返回结构化JSON                     | 响应时间5s    |
| TC-10  | 输出结构验证   | 1. 验证JSON输出                                                      | 字段完整且格式正确                 | 通过率100%    |
| TC-11  | 代码引用验证   | 1. 查询"calculate_turnover_rate"<br>2. 验证引用                      | 引用精确到代码行                   | 准确率95%     |
| TC-12  | 文档引用验证   | 1. 查询"库存管理"<br>2. 验证引用                                     | 引用精确到章节                     | 准确率90%     |
| TC-13  | CLI命令执行    | 1. 执行完整CLI命令<br>2. 验证输出                                    | 命令执行成功                       | 通过率100%    |
| TC-14  | 首建库流程     | 1. 从原始数据构建索引<br>2. 验证流程                                 | 索引构建成功                       | 构建时间15分钟 |
| TC-15  | 指标校验（一致）| 1. 查询"库存周转率"<br>2. 验证指标                                   | notes为空，confidence≥0.8          | 一致率95%     |

表4-1：正向测试用例

### 4.2 异常测试用例

| 用例ID | 测试点           | 步骤                                                                 | 期望结果                                 | 量化阈值     |
| ------ | ---------------- | -------------------------------------------------------------------- | ---------------------------------------- | ------------ |
| TC-16  | 指标校验（超差） | 1. 构造超差场景（+6%）<br>2. 验证系统响应                            | notes含超差说明，confidence=0.5          | 通过率100%   |
| TC-17  | 空目录导入       | 1. 执行python main.py run --build-index指向空目录<br>2. 验证响应     | 返回友好提示                             | 通过率100%   |
| TC-18  | 空检索           | 1. 查询"xyz123"<br>2. 检查响应                                       | 返回"未找到相关知识"                     | 通过率100%   |
| TC-19  | JSON解析失败     | 1. 模拟LLM返回无效JSON<br>2. 验证系统响应                            | 降级处理，confidence=0.3                 | 通过率100%   |
| TC-20  | 引用缺失         | 1. 模拟无引用响应<br>2. 验证系统处理                                 | 生成默认引用，notes说明                  | 通过率100%   |
| TC-21  | 指标单位不明     | 1. 构造单位不明场景<br>2. 验证系统响应                               | confidence降至0.6                        | 通过率100%   |
| TC-22  | 索引损坏         | 1. 破坏索引文件<br>2. 验证系统行为                                   | 自动重建索引                             | 通过率100%   |
| TC-23  | 长上下文         | 1. 提交超长查询<br>2. 验证提示词                                     | 提示词被正确裁剪                         | 通过率100%   |
| TC-24  | BM25开关测试     | 1. 分别设置USE_BM25=true/false<br>2. 比较结果                        | 混合检索结果更准确                       | 改进率5%     |
| TC-25  | Top-k敏感性      | 1. 测试k=3,5,10<br>2. 比较结果                                       | k=5时性能最优                            | 通过率100%   |
| TC-26  | 禁网验证         | 1. 断开网络<br>2. 执行完整流程                                       | 系统正常运行（使用Mock模式）             | 通过率100%   |
| TC-27  | 仅CPU验证        | 1. 确保无GPU<br>2. 执行检索                                          | 检索成功                                 | 通过率100%   |
| TC-28  | 无微调验证       | 1. 检查代码<br>2. 验证配置                                           | 无微调相关代码                           | 通过率100%   |
| TC-29  | dev_set批处理    | 1. 运行python evaluate.py<br>2. 验证结果                             | 达到验收标准                             | 通过率100%   |
| TC-30  | CLI参数验证      | 1. 测试缺失参数场景<br>2. 验证错误提示                               | 返回明确错误信息                         | 通过率100%   |

表4-2：异常测试用例

## 5. 证据与日志命名规范

### 5.1 证据命名规则

所有测试证据按以下规则命名：
`{用例ID}_{证据类型}_{时间戳}.{扩展名}`

- 用例ID：TC-XX（如TC-01）
- 证据类型：
  - log：日志文件
  - output：命令输出
  - screenshot：截图
  - report：测试报告
  - data：测试数据
- 时间戳：YYYYMMDD_HHMMSS
- 扩展名：根据内容类型（log, txt, png, csv等）

示例：
- TC-01_log_20250518_143022.log
- TC-15_output_20250518_152211.json
- TC-16_screenshot_20250518_160533.png

### 5.2 日志内容规范

日志文件必须包含以下信息：
`[时间戳] [日志级别] [模块名] 日志消息`
`[可选] 详细上下文（如查询内容、错误堆栈等）`

示例：
```
[2025-05-18 14:22:18] [INFO] [Retriever] Starting retrieval for query: "如何计算库存周转率？"
[2025-05-18 14:22:19] [DEBUG] [Retriever] FAISS retrieved 7 documents
[2025-05-18 14:22:19] [DEBUG] [Retriever] BM25 retrieved 5 documents
[2025-05-18 14:22:19] [INFO] [Retriever] Merged and deduplicated to 5 documents
```

证据：logs/app_20250518.log 符合规范

### 5.3 测试结果保存路径

```
test_results/
├── functional/           # 功能测试结果
│   ├── TC-01_log_*.log
│   ├── TC-02_output_*.json
│   └── ...
├── performance/          # 性能测试结果
│   ├── retrieval_perf.csv
│   └── llm_perf.log
├── metric_validation/    # 指标校验结果
│   ├── consistency.csv
│   └── 超差案例/
│       └── TC-16_*.json
├── screenshots/          # 截图证据
│   ├── TC-11_*.png
│   └── TC-12_*.png
└── reports/              # 测试报告
    ├── functional_report.pdf
    └── performance_report.pdf
```

## 6. 追踪矩阵

### 6.1 需求-用例追踪矩阵

| 需求ID  | 需求描述         | 测试用例ID                           |
| ------- | ---------------- | ------------------------------------ |
| FR-01   | 文档解析         | TC-01, TC-02                         |
| FR-02   | 清洗标准化       | TC-03, TC-04                         |
| FR-03   | 切块             | TC-03                                |
| FR-04   | 向量索引         | TC-05, TC-14                         |
| FR-05   | 检索器           | TC-06, TC-07, TC-24                  |
| FR-06   | 提示词模板       | TC-08                                |
| FR-07   | LLM调用与解析    | TC-09, TC-19                         |
| FR-08   | 指标校验         | TC-15, TC-16, TC-21                  |
| FR-09   | 输出结构化       | TC-10                                |
| FR-10   | CLI入口          | TC-13, TC-30                         |
| NFR-01  | 可运行性         | TC-26, TC-27, TC-28                  |
| NFR-02  | 鲁棒性           | TC-17, TC-18, TC-20, TC-22           |
| NFR-03  | 日志             | TC-01, TC-05, TC-09                  |
| NFR-04  | 性能             | TC-06, TC-07, TC-25                  |
| NFR-05  | 可维护性         | TC-05, TC-14                         |
| NFR-06  | 合规             | TC-04, TC-26, TC-28                  |

表6-1：需求-用例追踪矩阵

### 6.2 测试维度-用例分布

| 测试维度     | 覆盖用例                                   | 用例ID                              | 证据要求                 | 量化标准   |
| ------------ | ------------------------------------------ | ----------------------------------- | ------------------------ | ---------- |
| 可运行性     | 3                                          | TC-26, TC-27, TC-28                 | 系统启动日志、网络监控   | 启动时间60s |
| 相关性       | 5                                          | TC-06, TC-07, TC-24, TC-25, TC-29   | 检索结果、人工评估       | 相关性85%  |
| 完整性       | 4                                          | TC-10, TC-11, TC-12, TC-20          | 输出JSON、引用验证       | 完整性95%  |
| 引用准确性   | 5                                          | TC-11, TC-12, TC-19, TC-20, TC-29   | 引用截图、日志           | 准确率90%  |
| 指标校验     | 5                                          | TC-15, TC-16, TC-21, TC-29          | 超差案例、一致性报告     | 一致率95%  |
| 鲁棒性       | 8                                          | TC-17, TC-18, TC-22, TC-23, TC-30, ... | 错误日志、降级处理       | 通过率100% |

表6-2：测试维度-用例分布

## 7. 附录：测试执行计划

### 7.1 测试进度安排

| 阶段     | 主要任务                     |
| -------- | ---------------------------- |
| 准备阶段 | 环境搭建、数据准备           |
| 单元测试 | 模块级功能验证               |
| 组件测试 | 模块间接口测试               |
| 集成测试 | 核心流程验证                 |
| E2E测试  | 用户场景测试                 |
| 性能测试 | 压力与性能测试               |
| 报告编写 | 测试报告整理                 |

### 7.2 测试执行命令

#### 功能测试

```bash
# 运行所有功能测试
pytest tests/ -v

# 运行特定模块测试
pytest tests/test_retriever.py::test_bm25_retrieval -v
```

#### 性能测试

```bash
# 运行检索性能测试
python -m pytest tests/test_retriever.py -v --benchmark-only

# 运行端到端性能测试
time python main.py run --build-index > test_results/performance/end_to_end.log
```

#### 指标校验测试

```bash
# 运行指标校验测试
python tests/test_metric_validator.py
```

#### dev_set评测

```bash
# 运行完整dev_set评测
python evaluate.py \
  --dataset dev_set.jsonl \
  --output test_results/reports/dev_set_report.json
  
# 生成可视化报告
# 注：项目中未实现report_generator.py，需要后续开发
```