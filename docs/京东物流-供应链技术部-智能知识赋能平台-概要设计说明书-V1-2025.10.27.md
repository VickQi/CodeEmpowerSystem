# 概要设计说明书（HLD）

## 项目名称：智能知识赋能平台

编制单位：物流供应链研发组  
编制人：齐海智  
版本号：v1.0  
日期：2025-10-27  
保密级别：内部机密

## 修订记录

| 版本号 | 日期       | 修订人 | 修订内容                         |
| ------ | ---------- | ------ | -------------------------------- |
| v1.0   | 2025-10-27 | 齐海智 | 首次发布，完成概要设计           |

## 1. 架构总览

### 系统架构图

```
graph TD
    subgraph 离线CPU环境边界
        A[Loader] --> B[Cleaner]
        B --> C[Chunker]
        C --> D[Indexer]
        D --> E[Retriever]
        E --> F[Promptor]
        F --> G[LLM/Mock]
        G --> H[Parser&Synthesizer]
        H --> I[MetricValidator]
        I --> J[CLI]
        K[Logger] -.-> 所有模块
    end
    
    classDef offline fill:#e6f7ff,stroke:#1890ff,stroke-width:2px;
    class 离线CPU环境边界 offline;
    
    L[dev_set.jsonl] --> M[评测系统]
    M --> I
```

图1-1：系统架构总览图

### 架构说明：

1. **离线CPU环境**：所有组件均在标注的边界内运行，不依赖外部网络
2. **数据流**：从文档解析到CLI输出的端到端流程
3. **核心组件**：覆盖Loader到MetricValidator的10个关键模块
4. **日志系统**：统一收集所有模块日志
5. **评测系统**：独立于主流程，用于质量验证

## 2. 模块设计

### 2.1 Loader 模块

**功能**：加载各类文档和代码文件  
**职责**：
- 支持PDF、Markdown、Java、Python等格式
- 提取元数据（source, file_path, language等）
- 处理文件编码问题  
**关键实现**：[loader.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/loader.py)

### 2.2 Cleaner 模块

**功能**：清洗解析后的文本  
**职责**：
- 去除无关注释（TODO、FIXME等）
- 修复代码断行
- 标准化技术术语（"仓库""仓储"）
- 统一单位表示（"kg""KG"）  
**关键实现**：[cleaner.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/cleaner.py)

### 2.3 Chunker 模块

**功能**：按语义边界切分文本  
**职责**：
- 代码：按函数/方法边界切分
- 文档：按章节/段落切分
- 应用 `chunk_size=500`, `overlap=50` 策略  
**关键实现**: [chunker.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/chunker.py)

### 2.4 Indexer 模块

**功能**：构建和管理向量索引  
**职责**：
- 使用FAISS构建CPU索引
- 持久化索引文件
- 支持增量更新  
**关键实现**：[indexer.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/indexer.py)

### 2.5 Retriever 模块

**功能**：执行混合检索  
**职责**：
- 实现FAISS向量检索
- 可选BM25关键词检索
- 合并结果并去重  
**关键实现**: [retriver.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/retriver.py)

### 2.6 Promptor 模块

**功能**：组装LLM提示词  
**职责**：
- 拼接检索结果作为上下文
- 应用角色特定提示模板
- 处理上下文长度裁剪  
**关键实现**：[prompt.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/prompt.py)

### 2.7 LLM/Mock 模块

**功能**：调用LLM或Mock实现  
**职责**：
- 封装LLM调用接口
- 提供Mock实现用于禁网环境
- 处理调用失败回退  
**关键实现**：[llm.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/llm.py)

### 2.8 Parser&Synthesizer 模块

**功能**：解析LLM响应并合成最终输出  
**职责**：
- 验证JSON格式
- 提取关键信息
- 合成结构化响应  
**关键实现**：[parser.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/parser.py)

### 2.9 MetricValidator 模块

**功能**：校验物流指标一致性  
**职责**：
- 识别并提取指标值
- 与基准值比较
- 评估一致性并调整置信度  
**关键实现**：[metric_validator.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/metric_validator.py)

### 2.10 CLI 模块

**功能**：提供命令行接口  
**职责**：
- 解析用户命令
- 协调各模块执行
- 输出结构化结果  
**关键实现**：[main.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/main.py)

### 2.11 Logger 模块

**功能**：统一日志管理  
**职责**：
- 配置日志级别和格式
- 处理日志轮转
- 支持审计日志  
**关键实现**：[logger.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/logger.py)

## 3. 时序图

### 3.1 QA 链时序图

```
sequenceDiagram
    participant User as 用户
    participant CLI as CLI
    participant Retriever as Retriever
    participant Indexer as Indexer
    participant Promptor as Promptor
    participant LLM as LLM/Mock
    participant Parser as Parser
    participant Validator as MetricValidator
    
    User->>CLI: query("如何计算库存周转率？")
    CLI->>Retriever: retrieve(q, k=5, use_bm25=true)
    Retriever->>Indexer: load_index()
    Indexer-->>Retriever: FAISS索引
    Retriever->>Indexer: search(query)
    Indexer-->>Retriever: docs
    alt BM25启用
        Retriever->>BM25: search(query)
        BM25-->>Retriever: docs
        Retriever->>Retriever: merge_and_dedup()
    end
    Retriever-->>CLI: retrieved_docs
    CLI->>Promptor: build_prompt(q, docs, "dev")
    Promptor-->>CLI: messages
    CLI->>LLM: invoke(messages)
    LLM-->>CLI: raw_response
    CLI->>Parser: parse(raw, docs)
    alt JSON有效
        Parser-->>CLI: payload
    else JSON无效
        Parser->>Parser: repair_json()
        alt 修复成功
            Parser-->>CLI: payload
        else 修复失败
            Parser-->>CLI: fallback_response
        end
    end
    CLI->>Validator: validate(payload)
    Validator-->>CLI: validated_payload
    CLI-->>User: JSON输出
```

图3-1：QA链时序图

### 3.2 指标校验时序图

```
sequenceDiagram
    participant CLI as CLI
    participant Validator as MetricValidator
    participant Reference as 参考数据
    
    CLI->>Validator: validate(payload, reference_data)
    Validator->>Validator: extract_metrics(payload)
    loop 每个指标
        Validator->>Validator: get_reference_value()
        Validator->>Validator: is_within_tolerance()
        alt 超出容差
            Validator->>Validator: update_notes()
            Validator->>Validator: reduce_confidence()
        end
    end
    Validator-->>CLI: updated_payload
```

图3-2：指标校验时序图

## 4. 接口契约

### 4.1 核心接口表

| 模块 | 函数签名 | 输入/输出 | 异常 | 配置键 |
|------|----------|-----------|------|--------|
| Retriever | `retrieve(q: str, k: int = 5, use_bm25: bool = True) -> List[RetrievedDocument]` | 输入：查询语句<br>输出：检索结果列表 | RetrievalError（检索失败） | TOP_K=5<br>USE_BM25=true |
| Promptor | `build_prompt(question: str, docs: List[RetrievedDocument], agent_type: str = 'dev') -> List[Message]` | 输入：查询+文档+角色类型<br>输出：消息序列 | 无特定异常（直接裁剪处理） | MAX_CONTEXT_CHARS=3500 |
| LLM | `invoke(messages: List) -> str` | 输入：消息序列<br>输出：原始响应 | LLMInvocationError（调用失败） | USE_MOCK=true |
| Parser | `parse(raw: str, docs: List) -> dict` | 输入：原始响应+文档<br>输出：结构化payload | JSONParseError（解析失败） | - |
| Validator | `validate(payload: dict, ref: dict) -> dict` | 输入：payload+参考数据<br>输出：验证后payload | MetricValidationError（校验失败） | - |

表4-1：核心接口契约

### 4.2 输出数据模型

```
{
  "answer": "回答内容",
  "citations": ["[Source#Location]"],
  "used_metrics": [
    {
      "name": "metric_name",
      "value": "metric_value",
      "unit": "unit"
    }
  ],
  "notes": "校验备注",
  "confidence": 0.85
}
```

## 5. 关键设计取舍

### 5.1 检索结果融合策略

**设计**：支持向量检索与可选的 BM25 关键词检索融合（默认仅使用向量检索）

**实现细节**：
- 向量检索使用 FAISS 索引
- BM25 检索通过 `SimpleBM25Index` 提供基础关键词匹配（需外部显式注入）
- 若启用 BM25，则按以下公式融合得分：  
  `final_score = 0.7 * vector_score + 0.3 * normalized_bm25`
- 结果按得分排序后基于 `source` 去重

**理由**：
- 向量检索捕获语义相似性
- BM25 作为关键词补充
- 保持代码简洁、易调试

**代码位置**：[`retriver.py`](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/retriver.py) 中 `_merge_results` 方法  

**备注**：根据配置文件，默认启用 BM25 检索（USE_BM25=true），但 BM25 索引需要外部显式注入，当前运行模式实际为**仅向量检索**；BM25 支持预留供后续扩展。

### 5.2 切块与长度裁剪策略

**切块策略**：
- 代码：按函数/方法边界
- 文档：按章节/段落
- `chunk_size=500`, `overlap=50`

**裁剪策略**：
- 保留首尾，移除中间部分
- `head_size = max_chars // 3`
- `tail_size = max_chars // 3`

**理由**：
- 首尾通常包含关键信息
- 避免截断关键上下文  
**实现**：[chunker.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/chunker.py)中的代码切块逻辑和[prompt.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/prompt.py)中的上下文裁剪逻辑

### 5.3 回退策略

| 场景 | 检测机制 | 处理策略 | 日志记录 | 影响范围 |
|------|----------|----------|----------|----------|
| 空检索 | 检索结果长度=0 | 返回友好提示 | ERROR级别记录 | 仅本次查询 |
| JSON解析失败 | 异常捕获 | 尝试修复降级为文本 | WARN+原始响应 | 本次生成质量 |
| 指标超差 | 差值>容差 | 写入notes，降低confidence | INFO级别记录 | 置信度评估 |
| 索引损坏 | 校验和验证 | 自动重建 | CRITICAL+通知 | 系统级 |

表5-1：回退策略矩阵

## 6. 配置与运行

### 6.1 配置中心

**配置文件**：[.env](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/.env)

```
# Qwen大模型API KEY
QWEN_API_KEY=sk-*******fa

# GPU使用设置
USE_GPU=false

# 日志设置
LOG_LEVEL=INFO
LOG_PATH=logs/

# 数据和向量存储设置
DATA_PATH=data/
VECTOR_STORE_PATH=vectorstore/

# 文本分块设置
CHUNK_SIZE=500
CHUNK_OVERLAP=50

# 检索设置
TOP_K=5
USE_BM25=true

# 上下文设置
MAX_CONTEXT_CHARS=3500

# Mock设置 (true表示使用Mock，false表示使用真实大模型)
USE_MOCK=true
```

**配置加载**：[settings.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/settings.py)

### 6.2 目录结构与持久化

```
project_root/
├── data/                  # 原始与处理数据
├── vectorstore/           # 向量索引
│   faiss.index            # FAISS索引文件
│   faiss.index.ids        # 文档ID映射
├── logs/                  # 日志文件
├── test_data/             # 测试数据
├── docs/                  # 文档
├── tests/                 # 测试文件
├── .env                   # 环境配置
```

## 7. 异常与降级策略

### 7.1 异常处理闭环

| 异常类型 | 检测机制 | 处理策略 | 日志记录 | 影响范围 |
|----------|----------|----------|----------|----------|
| 索引损坏 | 文件校验和验证 | 自动重建索引 | CRITICAL+通知 | 系统级 |
| 空检索 | 检索结果长度=0 | 返回友好提示 | WARN级别记录 | 仅本次查询 |
| JSON解析失败 | JSONDecodeError | 尝试修复降级处理 | WARN+原始响应 | 本次生成质量 |
| 引用缺失 | citations为空 | 生成默认引用 | INFO级别记录 | 引用准确性 |
| 单位不明 | 无法识别单位 | 标记为未知单位 | WARN级别记录 | 指标校验 |

### 7.2 降级策略实现

[parser.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/parser.py) 中 _fallback_response 方法

## 8. 安全与合规

### 8.1 禁网与不可微调

**禁网实现**：
- `ALLOW_INTERNET=false` 配置（在[settings.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/settings.py)中体现）
- 无网络请求代码（grep -r "requests\." src/ 无结果）
- MockLLM 替代真实LLM

**不可微调**：
- 无训练代码
- Embedding模型固定
- USE_FINE_TUNE 配置不存在

**证据**：[.env](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/.env) 中 USE_MOCK=true；[llm.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/llm.py) 无训练代码

### 8.2 数据脱敏

参见：[sanitizer.py](file:///Users/vick.qi/PycharmProjects/CodeEmpowerSystem/sanitizer.py) 中的脱敏规则